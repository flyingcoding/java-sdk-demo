# FISCO BCOS 自动化并行转账压测工具使用说明

## 📋 工具概述

本项目新增了两个一键式并行转账压测工具，无需手动生成用户文件，自动完成全部压测流程：

1. **AutoParallelOkPerf** - 完整自动化压测工具（带详细输出）
2. **QuickParallelPerf** - 快速压测工具（使用默认参数）
3. **AutoParallelOkMultiGroupPerf** - 多群组自动化压测工具（详细进度与验证）
4. **QuickParallelMultiGroupPerf** - 多群组快速压测工具（默认参数可选）

## ✨ 核心特性

- ✅ **自动生成用户** - 无需手动创建用户文件
- ✅ **自动部署合约** - 自动部署并行转账合约
- ✅ **自动添加账户** - 自动初始化用户账户
- ✅ **自动执行压测** - 自动完成转账压测
- ✅ **自动验证结果** - 自动验证账户余额
- ✅ **一行命令搞定** - 所有操作一次完成
- ✅ **多群组并发** - 多群组同时压测，互不影响

## 🚀 快速开始

### 前置准备

1. **确保 FISCO BCOS 节点运行正常**
2. **配置证书和连接信息**

```bash
# 1. 拷贝节点证书到配置目录
cp -r ~/fisco/nodes/127.0.0.1/sdk/* dist/conf/

# 2. 创建配置文件
cp dist/conf/config-example.toml dist/conf/config.toml

# 3. 修改 config.toml 中的节点地址（如需要）
# [network]
# peers=["127.0.0.1:20200"]
```

### 方式一：使用快速压测工具（单群组，推荐新手）

**无需任何参数，使用默认配置快速启动：**

```bash
cd dist
java -cp 'conf/:lib/*:apps/*' org.fisco.bcos.sdk.demo.perf.QuickParallelPerf
```

**默认配置：**
- 群组ID: 1
- 用户数量: 500
- 转账交易数: 5000
- 目标TPS: 100

**也可以自定义参数：**

```bash
java -cp 'conf/:lib/*:apps/*' org.fisco.bcos.sdk.demo.perf.QuickParallelPerf [groupId] [userCount] [transferCount] [tps]

# 示例：群组1，生成200个用户，执行2000笔转账，TPS为50
java -cp 'conf/:lib/*:apps/*' org.fisco.bcos.sdk.demo.perf.QuickParallelPerf 1 200 2000 50
```

### 方式二：使用完整自动化压测工具（单群组）

**提供完整的输出信息和进度显示：**

```bash
cd dist
java -cp 'conf/:lib/*:apps/*' org.fisco.bcos.sdk.demo.perf.AutoParallelOkPerf [groupId] [userCount] [transferCount] [tps]
```

**参数说明：**

| 参数 | 说明 | 示例 | 建议范围 |
|------|------|------|----------|
| groupId | 群组ID | 1 | 1-N |
| userCount | 生成的用户数量 | 1000 | 100-10000 |
| transferCount | 转账交易总数 | 10000 | 1000-100000 |
| tps | 目标TPS/QPS | 100 | 10-1000 |

**使用示例：**

```bash
# 基础压测：1000用户，10000笔交易，TPS为100
java -cp 'conf/:lib/*:apps/*' org.fisco.bcos.sdk.demo.perf.AutoParallelOkPerf 1 1000 10000 100

# 轻量压测：100用户，1000笔交易，TPS为50
java -cp 'conf/:lib/*:apps/*' org.fisco.bcos.sdk.demo.perf.AutoParallelOkPerf 1 100 1000 50

# 重度压测：5000用户，50000笔交易，TPS为500
java -cp 'conf/:lib/*:apps/*' org.fisco.bcos.sdk.demo.perf.AutoParallelOkPerf 1 5000 50000 500
```

### 方式三：多群组快速压测（默认参数可选）

**一行命令，多群组并发压测：**

```bash
cd dist
java -cp 'conf/:lib/*:apps/*' org.fisco.bcos.sdk.demo.perf.QuickParallelMultiGroupPerf [groupIds] [userCount] [transferCount] [tps]

# 示例：群组1、2并发，每组500用户、5000交易、TPS=100
java -cp 'conf/:lib/*:apps/*' org.fisco.bcos.sdk.demo.perf.QuickParallelMultiGroupPerf 1,2 500 5000 100
```

**参数说明：**
- groupIds: 逗号分隔的群组ID列表（如 `1,2,3`），默认 `1`
- userCount: 每群组用户数量，默认 `500`
- transferCount: 每群组转账交易数，默认 `5000`
- tps: 每群组目标TPS，默认 `100`

### 方式四：多群组自动化压测（详细进度与验证）

**多群组版本的完整自动化工具：**

```bash
cd dist
java -cp 'conf/:lib/*:apps/*' org.fisco.bcos.sdk.demo.perf.AutoParallelOkMultiGroupPerf [groupIds] [userCount] [transferCount] [tps]

# 示例：群组1、2并发，每组1000用户、10000交易、TPS=200
java -cp 'conf/:lib/*:apps/*' org.fisco.bcos.sdk.demo.perf.AutoParallelOkMultiGroupPerf 1,2 1000 10000 200
```

**参数说明：**
- groupIds: 逗号分隔的群组ID列表（如 `1,2,3`）
- userCount: 每群组用户数量
- transferCount: 每群组转账交易数
- tps: 每群组目标TPS

## 📊 压测流程

四个工具都会自动执行以下步骤：

```
1. 部署并行转账合约
   └─ 自动部署ParallelOk合约
   └─ 启用并行特性

2. 自动生成用户并添加到合约
   └─ 根据时间戳+索引自动生成用户名
   └─ 为每个用户初始化余额（1000000000）
   └─ 批量添加到区块链

3. 查询账户信息
   └─ 查询所有账户余额
   └─ 准备转账压测

4. 执行转账压测
   └─ 随机选择转账金额（1-100）
   └─ 按指定TPS执行转账
   └─ 实时显示进度

5. 验证结果
   └─ 对比本地余额和链上余额
   └─ 确保数据一致性
```

## 📈 输出示例（多群组快速）

```
╔════════════════════════════════════════════════════════════════╗
║        FISCO BCOS 多群组并行转账快速压测工具                  ║
╚════════════════════════════════════════════════════════════════╝

📊 压测配置:
   群组列表      : [1, 2]
   每组用户数    : 500
   每组交易数    : 5000
   每组目标TPS   : 100

[Group 1] ⏳ [1/4] 部署并行合约...
[Group 1] ✅ 合约部署成功: 0x1234...
[Group 2] ⏳ [1/4] 部署并行合约...
[Group 2] ✅ 合约部署成功: 0xabcd...
...
```

## 🔧 参数调优建议

### 根据节点性能调整参数

| 场景 | 用户数 | 交易数 | TPS | 适用情况 |
|------|--------|--------|-----|----------|
| 快速验证 | 50-100 | 500-1000 | 10-50 | 快速验证功能 |
| 轻度压测 | 100-500 | 1000-5000 | 50-100 | 测试环境 |
| 中度压测 | 500-2000 | 5000-20000 | 100-300 | 开发环境 |
| 重度压测 | 2000-5000 | 20000-100000 | 300-1000 | 生产环境预演 |
| 极限压测 | 5000+ | 100000+ | 1000+ | 性能极限测试 |

### 注意事项

1. **用户数量建议**
   - 用户数至少为转账数的 1/10（以确保有足够的并行度）
   - 用户数过少会导致转账冲突增加
   - 用户数过多会增加初始化时间

2. **TPS 设置建议**
   - 从较小的TPS开始（如50），逐步增加
   - 观察节点CPU和内存使用率
   - 不要超过节点处理能力

3. **转账数量建议**
   - 初次测试建议使用较小数值（1000-5000）
   - 根据测试结果逐步增加
   - 注意观察交易成功率

## ❓ 常见问题

### 1. 配置文件找不到

**问题：** `配置文件 config.toml 不存在！`

**解决：**
```bash
cp dist/conf/config-example.toml dist/conf/config.toml
```

### 2. 连接节点失败

**问题：** 无法连接到区块链节点

**解决：**
- 检查节点是否正常运行
- 检查 config.toml 中的节点地址和端口
- 确保证书文件已正确拷贝

### 3. TPS 达不到预期

**问题：** 实际TPS远低于设置的TPS

**可能原因：**
- 节点性能瓶颈
- 网络延迟
- 线程池配置过小

**解决：**
- 调整 config.toml 中的线程池大小
- 检查节点资源使用情况
- 降低目标TPS

### 4. 验证失败

**问题：** 部分账户余额验证失败

**可能原因：**
- 交易未完全确认
- 并发冲突

**解决：**
- 等待更长时间让交易确认
- 减小TPS或用户数

## 📝 与原工具对比

| 特性 | 原工具 (ParallelOkPerf) | 新工具 (AutoParallelOkPerf) | 快速工具 (QuickParallelPerf) | 多群组自动化 | 多群组快速 |
|------|-------------------------|------------------------------|-------------------------------|-------------|-----------|
| 用户生成 | 手动两步 | ✅ 自动生成 | ✅ 自动生成 | ✅ 自动生成 | ✅ 自动生成 |
| 文件存储 | 需要文件 | ❌ 无需文件 | ❌ 无需文件 | ❌ 无需文件 | ❌ 无需文件 |
| 命令数量 | 2条命令 | 1条命令 | 1条命令 | 1条命令 | 1条命令 |
| 操作步骤 | add + transfer | 一次完成 | 一次完成 | 一次完成 | 一次完成 |
| 适用场景 | 需要保存用户 | 快速压测 | 最快速验证 | 多群组详细 | 多群组快速 |
| 详细输出 | ✅ | ✅ | 简洁 | ✅ | 简洁 |

## 🎯 最佳实践

1. **首次使用建议：**
   ```bash
   # 使用快速工具（单群组），无需参数
   java -cp 'conf/:lib/*:apps/*' org.fisco.bcos.sdk.demo.perf.QuickParallelPerf
   ```

2. **多群组快速验证：**
   ```bash
   # 一行命令对多个群组并发压测
   java -cp 'conf/:lib/*:apps/*' org.fisco.bcos.sdk.demo.perf.QuickParallelMultiGroupPerf 1,2 300 3000 80
   ```

3. **多群组详细压测：**
   ```bash
   # 带详细进度与验证输出
   java -cp 'conf/:lib/*:apps/*' org.fisco.bcos.sdk.demo.perf.AutoParallelOkMultiGroupPerf 1,2 1000 10000 200
   ```

4. **性能调优流程：**
   - 先用小参数测试（100用户，1000交易）
   - 确认功能正常后逐步增加
   - 观察节点性能指标
   - 找到最佳TPS阈值

## 📞 技术支持

如有问题，请查看项目文档或提交 Issue。

---

**开发时间：** 2025-10

**版本：** 1.1.0

